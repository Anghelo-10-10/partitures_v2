# ğŸµ Partituras Musicales - API Spring Boot

AplicaciÃ³n backend para la gestiÃ³n de partituras musicales, desarrollada con **Spring Boot (Kotlin)**, **Spring Data JPA** y **PostgreSQL**.

Sistema completo para subir, gestionar, buscar y compartir partituras musicales en formato PDF con funcionalidades avanzadas de bÃºsqueda, favoritos y sistema de usuarios.

---

## ğŸ“‹ Requisitos previos

- **Java 21** (JDK 21)
- **PostgreSQL 15** o superior
- **Gradle 8** o superior
- **Git** (opcional)

---

## âš™ï¸ ConfiguraciÃ³n inicial

### 1. Clonar el repositorio
```bash
git clone https://github.com/Anghelo-10-10/partitures_v2.git
cd partitures
```

### 2. Iniciar Base de Datos con Docker
```bash
docker-compose up -d
```

### 3. Ejecutar el Proyecto
```bash
./gradlew bootRun
```

La aplicaciÃ³n se ejecuta en **http://localhost:8080/**

âš ï¸ **Nota**: La app actualmente es solo **API REST** (sin interfaz grÃ¡fica). Se puede probar con herramientas como **Postman**, **Insomnia** o **curl**.

---

## ğŸ—„ï¸ ConexiÃ³n a Base de Datos (PgAdmin)

**ConfiguraciÃ³n de conexiÃ³n:**

| Campo | Valor |
|-------|-------|
| **Host** | `localhost` |
| **Puerto** | `5433` |
| **Usuario** | `admin` |
| **Password** | `admin` |
| **Base de Datos** | `partitures_db` |

---

## ğŸš€ API Endpoints

### ğŸ” **AutenticaciÃ³n** (`/api/auth`)

| MÃ©todo | Endpoint | DescripciÃ³n | Body |
|--------|----------|-------------|------|
| `POST` | `/login` | Iniciar sesiÃ³n | `{"email": "user@email.com", "password": "password"}` |

### ğŸ‘¤ **Usuarios** (`/api/users`)

| MÃ©todo | Endpoint | DescripciÃ³n | Body/Params |
|--------|----------|-------------|-------------|
| `POST` | `/` | Crear usuario | `{"name": "Usuario", "email": "user@email.com", "password": "Password123"}` |
| `GET` | `/{id}` | Obtener usuario por ID | - |
| `PUT` | `/{id}` | Actualizar usuario | `{"name": "Nuevo Nombre", "email": "nuevo@email.com"}` |
| `DELETE` | `/{id}` | Eliminar usuario | - |
| `GET` | `/{id}/profile` | Obtener perfil pÃºblico | - |
| `PUT` | `/profile` | Actualizar mi perfil | `?userId=1` + `{"name": "Nombre", "bio": "Mi biografÃ­a"}` |

### ğŸ¼ **Partituras** (`/api/sheets`)

#### ğŸ“ **CRUD BÃ¡sico**
| MÃ©todo | Endpoint | DescripciÃ³n | Content-Type |
|--------|----------|-------------|--------------|
| `POST` | `/` | **Crear partitura con archivo PDF** | `multipart/form-data` |
| `GET` | `/{id}` | Obtener partitura por ID | - |
| `PUT` | `/{id}` | Actualizar metadatos de partitura | `application/json` |
| `PUT` | `/{id}/file` | Actualizar archivo PDF | `multipart/form-data` |
| `DELETE` | `/{id}` | Eliminar partitura | - |

#### ğŸ“„ **VisualizaciÃ³n y Descarga de PDFs**
| MÃ©todo | Endpoint | DescripciÃ³n | Respuesta |
|--------|----------|-------------|-----------|
| `GET` | `/{id}/pdf` | **Ver PDF en navegador** | PDF inline |
| `GET` | `/{id}/pdf/download` | **Descargar PDF** | PDF attachment |

#### ğŸ” **BÃºsqueda y Filtros**
| MÃ©todo | Endpoint | DescripciÃ³n | ParÃ¡metros |
|--------|----------|-------------|------------|
| `GET` | `/public` | Partituras pÃºblicas | - |
| `GET` | `/search` | BÃºsqueda simple | `?q=termino` |
| `GET` | `/search/advanced` | **BÃºsqueda avanzada** | `?searchTerm=&artist=&genre=&instrument=&sortBy=recent` |
| `GET` | `/genre/{genre}` | Filtrar por gÃ©nero | - |
| `GET` | `/instrument/{instrument}` | Filtrar por instrumento | - |
| `GET` | `/artist/{artist}` | Filtrar por artista | - |
| `GET` | `/recent` | Partituras recientes | - |
| `GET` | `/trending` | Partituras trending | - |

#### ğŸ“Š **Filtros Disponibles**
| MÃ©todo | Endpoint | DescripciÃ³n | Respuesta |
|--------|----------|-------------|-----------|
| `GET` | `/filters/genres` | GÃ©neros disponibles | `["Rock", "Jazz", "Classical"]` |
| `GET` | `/filters/instruments` | Instrumentos disponibles | `["Piano", "Guitar", "Violin"]` |
| `GET` | `/filters/artists` | Artistas disponibles | `["Artist 1", "Artist 2"]` |

#### ğŸ‘¤ **GestiÃ³n por Usuario**
| MÃ©todo | Endpoint | DescripciÃ³n | ParÃ¡metros |
|--------|----------|-------------|------------|
| `GET` | `/users/{userId}/owned` | Partituras propias del usuario | - |
| `GET` | `/users/{userId}/favorites` | Partituras favoritas del usuario | - |

#### â­ **Sistema de Favoritos**
| MÃ©todo | Endpoint | DescripciÃ³n | ParÃ¡metros |
|--------|----------|-------------|------------|
| `POST` | `/{sheetId}/favorites` | Agregar a favoritos | `?userId=1` |
| `DELETE` | `/{sheetId}/favorites` | Quitar de favoritos | `?userId=1` |
| `GET` | `/{sheetId}/is-favorite` | Verificar si es favorito | `?userId=1` |

### ğŸ“ **Archivos** (`/api/files`)

| MÃ©todo | Endpoint | DescripciÃ³n | Respuesta |
|--------|----------|-------------|-----------|
| `GET` | `/{fileName}` | Ver archivo | Archivo inline |
| `GET` | `/{fileName}/download` | Descargar archivo | Archivo attachment |
| `GET` | `/pdfs/{fileName}` | Ver PDF especÃ­fico | PDF inline |
| `GET` | `/pdfs/{fileName}/download` | Descargar PDF especÃ­fico | PDF attachment |

---

## ğŸ“ **Ejemplo de Uso - Crear Partitura**

### Request
```http
POST /api/sheets
Content-Type: multipart/form-data

file: [archivo.pdf]
title: "Moonlight Sonata"
description: "Sonata No. 14 de Beethoven"
artist: "Ludwig van Beethoven"
genre: "Classical"
instrument: "Piano"
isPublic: true
ownerId: 1
```

### Response
```json
{
"id": 1,
"title": "Moonlight Sonata",
"description": "Sonata No. 14 de Beethoven",
"artist": "Ludwig van Beethoven",
"genre": "Classical",
"instrument": "Piano",
"pdfFilename": "1698765432_abc12345.pdf",
"pdfSize": 2048576,
"pdfSizeMB": "2.0 MB",
"pdfContentType": "application/pdf",
"pdfDownloadUrl": "/api/sheets/1/pdf",
"isPublic": true,
"ownerId": 1,
"createdAt": "2024-01-15T10:30:00",
"updatedAt": "2024-01-15T10:30:00"
}
```

---

## âš¡ **CaracterÃ­sticas TÃ©cnicas Destacadas**

### ğŸ” **Sistema de BÃºsqueda Avanzado**
- **BÃºsqueda por mÃºltiples campos**: tÃ­tulo, artista, descripciÃ³n
- **Filtros combinables**: gÃ©nero, instrumento, artista
- **Ordenamiento**: por fecha, tÃ­tulo, artista
- **BÃºsqueda insensible a mayÃºsculas/minÃºsculas**

### ğŸ“ **GestiÃ³n de Archivos PDF**
- **ValidaciÃ³n estricta**: tamaÃ±o (mÃ¡x 5MB), tipo MIME, magic bytes
- **Almacenamiento**: PDFs guardados como BYTEA en PostgreSQL
- **OptimizaciÃ³n**: Lazy loading para archivos grandes
- **URLs dinÃ¡micas**: visualizaciÃ³n y descarga

### ğŸ‘¥ **Sistema de Usuarios y Permisos**
- **AutenticaciÃ³n**: Email + contraseÃ±a con validaciÃ³n robusta
- **EncriptaciÃ³n**: BCrypt para passwords
- **Propietarios**: Solo el owner puede modificar/eliminar
- **Perfiles**: InformaciÃ³n pÃºblica + biografÃ­a

### â­ **Sistema de Favoritos Inteligente**
- **RelaciÃ³n Many-to-Many**: UserSheet con metadata
- **Estados duales**: `isOwner` (propietario) + `isFavorite` (favorito)
- **GestiÃ³n flexible**: Agregar/quitar favoritos independientemente

### ğŸš€ **Optimizaciones de Performance**
- **Anti N+1 Queries**: Batch loading de propietarios
- **Lazy Loading**: Contenido PDF cargado bajo demanda
- **Ãndices de BD**: Optimizados para bÃºsquedas frecuentes
- **Queries nativas**: PostgreSQL ILIKE para bÃºsquedas eficientes

### âš ï¸ **Manejo de Errores Robusto**
- **Excepciones semÃ¡nticas**: Por dominio (users, sheets, files)
- **CÃ³digos HTTP correctos**: 404, 400, 409, 403, 500
- **Mensajes contextuales**: Con informaciÃ³n especÃ­fica del error
- **GlobalExceptionHandler**: Manejo centralizado

---

## ğŸ—‚ï¸ **Estructura del Proyecto**

```
src/main/kotlin/com/partituresforall/partitures/
â”œâ”€â”€ ğŸ® controllers/          # API REST endpoints
â”‚   â”œâ”€â”€ AuthController       # AutenticaciÃ³n
â”‚   â”œâ”€â”€ UserController       # GestiÃ³n de usuarios
â”‚   â”œâ”€â”€ SheetController      # GestiÃ³n de partituras
â”‚   â””â”€â”€ FileController       # GestiÃ³n de archivos
â”œâ”€â”€ ğŸ§  services/             # LÃ³gica de negocio
â”‚   â”œâ”€â”€ UserService          # Operaciones de usuario
â”‚   â”œâ”€â”€ SheetService         # Operaciones de partituras
â”‚   â”œâ”€â”€ FileService          # GestiÃ³n de archivos
â”‚   â””â”€â”€ FileValidationService # Validaciones centralizadas
â”œâ”€â”€ ğŸ—„ï¸ repositories/         # Acceso a datos (JPA)
â”‚   â”œâ”€â”€ UserRepository       # Consultas de usuario
â”‚   â”œâ”€â”€ SheetRepository      # Consultas de partituras
â”‚   â””â”€â”€ UserSheetRepository  # RelaciÃ³n usuario-partitura
â”œâ”€â”€ ğŸ—ï¸ models/               # Modelos de datos
â”‚   â”œâ”€â”€ entities/            # Entidades JPA (User, Sheet, UserSheet)
â”‚   â”œâ”€â”€ requests/            # DTOs de entrada
â”‚   â””â”€â”€ responses/           # DTOs de salida
â”œâ”€â”€ âš ï¸ exceptions/           # Manejo de errores
â”‚   â”œâ”€â”€ exceptions/          # Excepciones custom por dominio
â”‚   â””â”€â”€ handlers/            # GlobalExceptionHandler
â””â”€â”€ âš™ï¸ config/               # Configuraciones
â””â”€â”€ PasswordEncoder      # Encoder BCrypt personalizado
```

---

## ğŸ› ï¸ **ConfiguraciÃ³n TÃ©cnica**

| TecnologÃ­a | VersiÃ³n | PropÃ³sito |
|------------|---------|-----------|
| **Spring Boot** | 3.5.0 | Framework principal |
| **Kotlin** | 1.9+ | Lenguaje de programaciÃ³n |
| **PostgreSQL** | 15 | Base de datos principal |
| **Hibernate** | 6.6.15 | ORM (Object-Relational Mapping) |
| **Docker** | - | Contenedor de PostgreSQL |
| **BCrypt** | - | EncriptaciÃ³n de contraseÃ±as |

---

## ğŸ”§ **ConfiguraciÃ³n de Desarrollo**

### Variables de Entorno (`application.yml`)
```yaml
spring:
datasource:
url: jdbc:postgresql://localhost:5433/partitures_db
username: admin
password: admin

servlet:
multipart:
max-file-size: 10MB
max-request-size: 10MB

app:
file:
upload-dir: uploads
```

### Docker Compose
```yaml
services:
postgres:
image: postgres:15
environment:
POSTGRES_DB: partitures_db
POSTGRES_USER: admin
POSTGRES_PASSWORD: admin
ports:
- "5433:5432"
```

---

## ğŸš€ **PrÃ³ximas Mejoras Planeadas**

- [ ] **AutenticaciÃ³n JWT** + Spring Security
- [ ] **Validaciones @Valid** en controllers
- [ ] **PaginaciÃ³n** para endpoints de listas
- [ ] **Tests unitarios** e integraciÃ³n
- [ ] **DocumentaciÃ³n Swagger/OpenAPI**
- [ ] **Cache Redis** para consultas frecuentes
- [ ] **MÃ©tricas y observabilidad**
- [ ] **Interfaz web frontend**

---

## ğŸ§ª **Testing Manual**

Puedes probar la API usando **Postman**, **Insomnia** o **curl**:

```bash
# Crear usuario
curl -X POST http://localhost:8080/api/users \
-H "Content-Type: application/json" \
-d '{"name":"Test User","email":"test@example.com","password":"Password123"}'

# Login
curl -X POST http://localhost:8080/api/auth/login \
-H "Content-Type: application/json" \
-d '{"email":"test@example.com","password":"Password123"}'

# Obtener partituras pÃºblicas
curl http://localhost:8080/api/sheets/public
```

---

## ğŸ“ **Contacto y ContribuciÃ³n**

- **Repositorio**: [GitHub - partitures_v2](https://github.com/Anghelo-10-10/partitures_v2)
- **Autor**: Anghelo-10-10
- **Stack**: Kotlin + Spring Boot + PostgreSQL

---

**Â¡La API estÃ¡ lista para ser consumida por cualquier frontend o aplicaciÃ³n mÃ³vil!** ğŸµâœ¨